# ExifTool Synchronization Guide

This guide documents how exif-oxide tracks knowledge from Phil Harvey's ExifTool and incorporates updates as ExifTool evolves.

## The problems

1. ExifTool is updated monthly, and every version contains changes that touch all parts of the codebase.
2. Parsing `perl` with anything other than `perl` is an exercise in futility
3. The structures and code in ExifTool are _complicated_
4. There will always be a need for manual edits and updates to what the sync system can provide. An example of this is PrintConv implementations -- we can't directly execute the perl PrintConv code -- apart from the sync tooling, we need to manually implement those functions in Rust, and _something_ needs to map the autogenerated table from sync with our manually-written functions.
5. All exiftool_sync jobs MUST be idempotent

## The Solution: Semi-guided Implementation

The sync system will continue to extract and generate code as it does today, but will also analyze what it can't automatically handle or what may be problematic, and emit a prioritized todo list. When sync runs, it will:

1. Extract and generate all the tables/code it can (as today)
2. Identify gaps, missing algorithms, and manual work needed (like missing PrintConv implementations)
3. Output a structured todo list (machine-readable JSON format)
4. Provide specific ExifTool source locations and implementation guidance

This transforms sync from just a code generator into an implementation assistant that both generates what it can AND tells you exactly what manual work remains.

Example output:

```bash
$ cargo run --bin exiftool_sync extract-all
‚úì Extracted EXIF tags (643 tags)
‚úì Extracted Canon tags (421 tags)
‚úì Generated maker detection patterns

‚ö†Ô∏è  Found 23 issues requiring manual implementation:
   üî¥ High priority: 5
   üü° Medium priority: 12
   üü¢ Low priority: 6

   See sync-todos.jsonl for details
```

The JSON format enables Claude Code and other tools to parse and present the todos effectively:

```json
{
  "issues": [
    {
      "priority": "high", // low, medium or high
      "command": "extract_printconv",
      "perl_source": {
        "file": "lib/Image/MakerNote.pm",
        "lines": "4521-4687"
      },
      "rust_target": "src/jpeg/validator.rs", // optional
      "description": "Missing PrintConv implementation for ‚òÖ‚òÖ‚òÖ‚òÖ ‚úî EXIF::Aperture.",
      "suggested_implementation": "Port the Aperture PrintConv and rerun."
    }
  ]
}
```

### Implementation: JSON Lines Format

Each sync command appends its issues to a shared `sync-todos.jsonl` file using JSON Lines format (one JSON object per line). This works because:

1. **Serial execution** - The `extract-all` command runs extractors sequentially (no concurrency issues)
2. **Streaming reads** - Tools can process issues line-by-line
3. **Simple implementation** - No JSON parsing/merging needed

The sync issue functionality is available in `src/bin/exiftool_sync/extractors/mod.rs`:

```rust
use extractors::{emit_sync_issue, PerlSource, Priority, SyncIssue};

// Example usage in an extractor
if missing_printconv {
    emit_sync_issue(SyncIssue {
        priority: Priority::High,
        command: "extract_exif_tags".to_string(),
        perl_source: PerlSource {
            file: "lib/Image/ExifTool/Exif.pm".to_string(),
            lines: Some("4521-4687".to_string()),
        },
        rust_target: Some("src/core/validator.rs".to_string()),
        description: "Missing PrintConv implementation for SubjectDistanceRange".to_string(),
        suggested_implementation: "Add SubjectDistanceRange to PrintConvId enum".to_string(),
    })?;
}
```

The `extract-all` command clears the file at the start, then runs each extractor in sequence. The command reports how many issues were found at the end.

## Source Tracking

### Module-Level Attribution

Each Rust file that manually re-implements ExifTool functionality that isn't rebuilt automatically by `sync` must include doc attributes at the top.

```rust
//! Canon maker note parsing implementation

#![doc = "EXIFTOOL-SOURCE: lib/Image/ExifTool/Canon.pm"]
#![doc = "EXIFTOOL-SOURCE: lib/Image/ExifTool/CanonRaw.pm"]

// rest of implementation...
```

For auto-generated files:

```rust
// AUTO-GENERATED from ExifTool v12.65
// Source: lib/Image/ExifTool/Canon.pm (Main, PreviewImageInfo tables)
// Generated: 2024-12-22 by build.rs
// DO NOT EDIT - Regenerate with `make sync`
```

### Why This Approach?

1. **Simple** - Just doc attributes at the top of each file
2. **Greppable** - Easy to find all files affected by a Perl module change
3. **Parseable** - Can be extracted programmatically when needed
4. **Self-documenting** - Shows up in rustdoc
5. **No separate files** - Attribution travels with the code
