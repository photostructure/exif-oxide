# Smooth Extractor Pattern Guide

This document describes the required pattern for all ExifTool extractors to ensure smooth regeneration without manual intervention.

## Overview

All extractors must follow the "smooth regeneration" pattern that guarantees:

- ✅ **Zero manual steps** - Single command always works
- ✅ **Build resilience** - Never breaks compilation due to missing files
- ✅ **Clear feedback** - Users know if real data or stubs were generated
- ✅ **Consistent experience** - All extractors work the same way

## Required Pattern

### 1. Build Script Stub Creation

If your extractor generates files that are imported as Rust modules, add stub creation to `build.rs`:

```rust
// In build.rs main() function
ensure_your_component_exists();

// At end of build.rs
fn ensure_your_component_exists() {
    let file_path = "src/path/to/your_generated_file.rs";

    if !Path::new(file_path).exists() {
        let _ = fs::create_dir_all("src/path/to");

        let stub_content = r#"// STUB: Auto-generated by build.rs to ensure compilation
// Regenerate with: cargo run --bin exiftool_sync extract your-component

#![doc = "EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm"]

// Minimal compilable stub implementation
"#;

        if let Err(e) = fs::write(file_path, stub_content) {
            eprintln!("Warning: Failed to create stub {}: {}", file_path, e);
        } else {
            println!("Created stub file: {}", file_path);
        }
    }
}
```

### 2. Smart Extractor Implementation

Your extractor's `extract()` method must follow this pattern:

```rust
impl Extractor for YourExtractor {
    fn extract(&self, exiftool_path: &Path) -> Result<(), String> {
        println!("Extracting your component from ExifTool...");

        let mut extractor = Self::new();

        // Always attempt extraction (never fail completely)
        match extractor.parse_your_data(exiftool_path) {
            Ok(()) => {
                println!("Found {} items", extractor.items.len());
            }
            Err(e) => {
                println!("Warning: Failed to parse: {}", e);
                println!("  - Generating stub implementation");
            }
        }

        // Always generate code (real or stub)
        let code = if extractor.items.is_empty() {
            extractor.generate_stub_code()?
        } else {
            extractor.generate_real_code()?
        };

        // Always write output
        extractor.write_output(&code)?;

        // Clear completion message
        println!("Component extraction completed successfully");
        if extractor.items.is_empty() {
            println!("  - Using stub implementation (no data found)");
        } else {
            println!("  - Generated {} items", extractor.items.len());
        }

        Ok(())
    }
}
```

### 3. Stub Code Generation

Add a `generate_stub_code()` method that produces minimal compilable code:

```rust
impl YourExtractor {
    fn generate_stub_code(&self) -> Result<String, String> {
        let mut code = String::new();

        code.push_str("//! Auto-generated stub implementation\n");
        code.push_str("//!\n");
        code.push_str("//! EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\n");
        code.push_str("//! This is a stub file generated when no data was found.\n");
        code.push_str("//! Regenerate with: cargo run --bin exiftool_sync extract your-component\n\n");

        code.push_str("#![doc = \"EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\"]\n\n");

        // Add minimal data structures and functions that compile
        code.push_str("/// Stub data (empty - regenerate to populate)\n");
        code.push_str("pub static YOUR_DATA: &[YourType] = &[\n");
        code.push_str("    // Stub - real data will be generated by extractor\n");
        code.push_str("];\n\n");

        code.push_str("/// Stub function\n");
        code.push_str("pub fn your_function() -> Option<YourResult> {\n");
        code.push_str("    None // Stub implementation\n");
        code.push_str("}\n");

        Ok(code)
    }
}
```

### 4. Consistent Output Headers

Use this header pattern for all generated files:

```rust
// For real generated files
let header = format!(
    "//! Auto-generated {} from ExifTool\n\
     //!\n\
     //! EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\n\
     //! EXIFTOOL-VERSION: {}\n\
     //!\n\
     //! This file is auto-generated by exiftool_sync extract {}.\n\
     //! Do not edit manually.\n\n\
     #![doc = \"EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\"]\n\n",
    component_name,
    exiftool_version,
    component_name
);

// For stub files
let header = format!(
    "//! Auto-generated stub {} from ExifTool\n\
     //!\n\
     //! EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\n\
     //! This is a stub file generated when no data was found.\n\
     //! Regenerate with: cargo run --bin exiftool_sync extract {}\n\n\
     #![doc = \"EXIFTOOL-SOURCE: lib/Image/ExifTool/Source.pm\"]\n\n",
    component_name,
    component_name
);
```

## Testing Your Extractor

Verify your extractor follows the pattern:

### Test 1: Normal Operation

```bash
cargo run --bin exiftool_sync extract your-component
# Should work without errors
```

### Test 2: Missing Generated Files

```bash
rm src/path/to/your_generated_file.rs
touch build.rs  # Trigger build script
cargo build     # Should succeed (creates stub)
cargo run --bin exiftool_sync extract your-component  # Should work
```

### Test 3: Error Handling

```bash
# Test with invalid ExifTool path (temporarily rename directory)
mv third-party/exiftool third-party/exiftool.bak
cargo run --bin exiftool_sync extract your-component
# Should generate stub, not fail completely
mv third-party/exiftool.bak third-party/exiftool
```

## Integration Checklist

Before submitting a new extractor:

- [ ] Extractor never fails completely (always generates some output)
- [ ] Build script creates stub if generated file is missing
- [ ] `generate_stub_code()` method produces compilable code
- [ ] Clear success/failure messages with counts
- [ ] All generated files have proper EXIFTOOL-SOURCE attribution
- [ ] Tests pass for normal operation, missing files, and error cases
- [ ] Added to `cmd_extract_all()` in `main.rs`
- [ ] Updated help text with new component


## Benefits of This Pattern

1. **Developer Experience**: Single command always works
2. **CI/CD Reliability**: Builds never break due to missing files
3. **User Clarity**: Clear feedback about what was generated
4. **Maintainability**: Consistent patterns across all extractors
5. **ExifTool Updates**: Easy to regenerate everything after updates

This pattern ensures the ExifTool synchronization system remains robust and user-friendly as new extractors are added.
