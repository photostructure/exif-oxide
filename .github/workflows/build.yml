name: Build & Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump (patch, minor, major)"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick checks - format, clippy, and basic tests on Linux
  check:
    name: Format, Clippy & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          lfs: true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-check-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-check-${{ runner.os }}-

      - name: Setup ExifTool for integration tests
        run: |
          echo "${{ github.workspace }}/third-party/exiftool" >> $GITHUB_PATH
          third-party/exiftool/exiftool -ver

      - name: Run format check, clippy, and tests
        run: make check

  # Cross-platform testing
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: check
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          lfs: true

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: cargo-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-test-${{ runner.os }}-

      - name: Setup ExifTool (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "${{ github.workspace }}/third-party/exiftool" >> $GITHUB_PATH
          third-party/exiftool/exiftool -ver

      - name: Run tests
        run: cargo test --workspace --features test-helpers,integration-tests

  # Release - only runs on manual trigger
  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [check, test]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # stable
        with:
          toolchain: stable

      - name: Set up SSH signing
        uses: photostructure/git-ssh-signing-action@a770c2ff3aea31d9df9f2974ac9d672f2bfe62f3 # v1.1.0
        with:
          ssh-signing-key: ${{ secrets.SSH_SIGNING_KEY }}
          git-user-name: ${{ secrets.GIT_USER_NAME }}
          git-user-email: ${{ secrets.GIT_USER_EMAIL }}

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Bump version
        id: bump
        run: |
          cargo set-version --workspace --bump ${{ github.event.inputs.version }}
          NEW_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update Cargo.lock
        run: cargo update --workspace

      - name: Commit and tag
        run: |
          git add Cargo.toml Cargo.lock codegen/Cargo.toml exif-oxide-core/Cargo.toml
          git commit -m "chore(release): v${{ steps.bump.outputs.version }}"
          git tag "v${{ steps.bump.outputs.version }}" -m "v${{ steps.bump.outputs.version }}"

      - name: Push changes and tag
        run: |
          git push origin main
          git push origin "v${{ steps.bump.outputs.version }}"

      - name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@b7e9a28eded4986ec6b1fa40eeee8f8f165559ec # v1.0.3
        id: auth

      - name: Publish exif-oxide-core to crates.io
        run: cargo publish -p exif-oxide-core --token ${{ steps.auth.outputs.token }}

      - name: Publish exif-oxide to crates.io
        run: cargo publish -p exif-oxide --token ${{ steps.auth.outputs.token }}
